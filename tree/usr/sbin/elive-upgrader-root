#!/bin/bash
SOURCE="$0"
source /usr/lib/elive-tools/functions
el_make_environment
. gettext.sh
#TEXTDOMAIN="elive-upgrader"
#export TEXTDOMAIN

# Lock system (good one) {{{
lockfile="/tmp/.$(basename $0)-${USER}.lock"
#set -x

exit_ok(){
    rm -f "$lockfile"
}
exit_error(){
    rm -f "$lockfile"
}

if [[ -r "$lockfile" ]] ; then
    PROCCESS="$(cat $lockfile)"
else
    PROCCESS=" "
fi
if (ps up $PROCCESS) 1>/dev/null 2>&1 ; then
    el_error "$(basename $0) already running"
    exit
else
    echo $$ > "$lockfile"
fi

# traps needs to be after the lock verification, in order to not remove it when we are already running
trap "exit_ok" EXIT
trap "exit_error" 1 3 5 6 14 15 ERR TERM

# SET the lock file
echo "$$" > "$lockfile"


# end lock system }}}

update_upgrader(){
    if el_package_update_last_version -c "elive-upgrader" ; then
        if ! timeout 240 apt-get -f install ; then
            el_error "problem with apt-get -f install: $(apt-get -f install )"
            exit 1
        fi
        if ! timeout 240 apt-get update ; then
            if ! apt-get 360 update ; then
                el_error "problem updating package lists: $(apt-get update)"
                exit 1
            fi
        fi
        if ! timeout 240 TERM="" DISPLAY="" DEBIAN_FRONTEND=noninteractive apt-get install -q -y elive-upgrader ; then
            el_error "problem upgrading elive-upgrader: $(apt-get install -y elive-upgrader )"
            exit 1
        fi
    else
        el_debug "no new version of elive-upgrader found"
        exit 0
    fi

    exit 0
}

main(){
    # pre {{{
    version_elive="$( cat "/etc/elive-version" | grep "elive-version:" | awk '{print $2}' )"
    read -r version_elive <<< "$version_elive"

    hooks_d="/usr/lib/elive-upgrader/hooks"

    # }}}
    # never run on live mode {{{
    if grep -qs "boot=live" /proc/cmdline ; then
        exit
    fi

    # }}}


    for arg in "$@"
    do
        case "$arg" in
            #--delayed)
                #is_delayed=1
                #shift
                #;;
            --update)
                update_upgrader
                ;;
        esac
    done


    # always update before to run (if the package has been updated we want to fetch new code too)
    source /usr/lib/elive-upgrader/functions.sh

    # hooks: root
    run_hooks "root"

}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
